This module builds a data pipeline to load Postsecondary enrolments data from Statistics Canada. The data is hosted in a Digital Oceans S3 bucket for accessibility.

.. note::
   The data set is downloaded from Statistics Canada's website: 
   `Postsecondary Enrolments, by Institution Type, Registration Status
   <https://www150.statcan.gc.ca/t1/tbl1/en/cv.action?pid=3710001101>`_.
   The current system process 3M+ rows of data, loads it into data warehouse,
   transforms it using dbt, and makes it available for a PHP-based dashboard.
   

PSIS Pipeline
=============

This pipeline demonstrates loading data from a CSV file stored in an S3 bucket into a PostgreSQL database using `dlt`. It reads the PSIS enrolments data, transforms it using `dbt`, and makes it available for a PHP-based dashboard.

Pipeline Components
-------------------

- **Data Source**: A CSV file (``37100011.csv``) from Statistics Canada, hosted in a Digital Oceans S3 bucket.
- **ETL Tool**: ``dlt`` (data load tool) Python library for data ingestion.
- **Data Transformation**: ``dbt`` for transforming the raw data into analytical models (e.g., calculating location quotients).
- **Data Visualization**: A PHP and Chart.js dashboard for displaying the results.
- **Destination**: A PostgreSQL database instance.

Workflow
--------

The pipeline executes the following steps:

1.  **Initialization**: A ``dlt`` pipeline is initialized with the name ``psis_data_pipeline``, a ``postgres`` destination, and the dataset name ``psis_data``.
2.  **Data Loading**: The ``parse_psis_enrolments`` resource reads the CSV file from the S3 bucket.
3.  **Table Creation & Insertion**: ``dlt`` creates the ``psis_enrolments`` table and inserts the data.
4.  **Data Transformation**: After the data is loaded, `dbt` runs to transform the raw enrolment data. This includes creating models like ``fct_location_quotient`` to calculate regional program specialization.
5.  **Data Visualization**: The PHP dashboard queries the transformed data from the PostgreSQL database to visualize the location quotient for different provinces and years.
6.  **Termination**: The pipeline run finishes, and load information is printed to the console.

Workflow Diagram
~~~~~~~~~~~~~~~~

.. mermaid::
   :name: psis_pipeline_workflow

   graph TD
      A[Start] --> B{Initialize dlt Pipeline};
      B --> C{Call parse_psis_enrolments resource};

      subgraph "parse_psis_enrolments resource"
         C --> D[Read 37100011.csv from S3];
      end

      D --> E{Load data into psis_enrolments table};
      E --> G{Transform data with dbt};
      G --> H{Visualize with PHP Dashboard};
      H --> F[End];

Data Transformation Layer with DBT
-----------------------------------
.. note::
    The `stg_enrollment` model handles renaming columns and extrating the start year from 
    the academic year string using SQL functions.

After loading the raw PSIS enrolments data into the PostgreSQL database, 
`dbt` is used to transform the data into more analytical forms. Key 
transformations include:

1.  **Staging Model**: The `stg_enrollment` model cleans and standardizes the raw data.
2.  **Fact Model**: The `fct_location_quotient` model calculates the location 
    quotient for various fields of study across provinces and years.

.. warning::
    StatCan files are pre-aggregated CUBES and often contain sum totals as a seperate row,
    in the same columns as the individual data. `fct_location_quotient` model filters out these
    total rows to ensure accurate calculations.

Dashboard Integration
-----------------------
The transformed data is then utilized by a PHP-based dashboard that leverages Chart.js for 
visualization. The dashboard connects to the PostgreSQL database to fetch the location 
quotient data and displays it in an interactive format, allowing users to explore regional 
program specializations over time.

.. tip::
   The dashboard code is in progress. The end to end system architecture is ready
   and available on `GitHub: PSIS Monrepo <https://github.com/aarishgilani/psis-monorepo>`_

Technical Documentation
------------------------

.. note:: Following section is auto-generated by `sphinx-autodoc-typehints` extension.

.. automodule:: psis_pipeline
    :members:
    :undoc-members:
    :show-inheritance:

